rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /insurers/{insurer} {
      allow read: if true;
      allow write: if get(/databases/$(database)/documents/insurers/$(insurer)/users/$(request.auth.uid)).data.isAdmin
      match /products/{product} {
        allow read: if true;
        allow write: if get(/databases/$(database)/documents/insurers/$(insurer)/users/$(request.auth.uid)).data.isAdmin
      }
		}
    match /classifier/{document=**} {
      allow read: if true;
      allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin;
		}
    match /policies/{document=**} {
      allow read: if true;
      allow write: if true;
		}
    match /users/{user}/{document=**} {
      allow read: if user == request.auth.uid;
      allow write: if (
        user == request.auth.uid
        && request.resource.data.isAdmin == resource.data.isAdmin
        && request.resource.data.isInsurer == resource.data.isInsurer
      ) || (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin
      )
		}
  }
}
